main:
  params: [args]
  steps:
    - eventTypeSwitch:
        switch:
            - condition: ${args.eventType == "OBJECT_FINALIZE"}
              next: thumbnailCall
            - condition: ${args.eventType == "OBJECT_DELETE"}
              next: garbageCollectorCall
    - eventTypeNotSupported:
        raise: ${"eventType " + args.eventType + " is not supported"}
        next: end
    - thumbnailCall:
        call: http.post
        args:
          url: ${args.thumbnailUri}
          auth:
            type: OIDC
          body:
              gcsImageUri: ${args.gcsImageUri}
        result: thumbnailResponse
    - collageCall:
        call: http.get
        args:
          url: ${args.collageUri}
          auth:
            type: OIDC
        result: collageResponse
    - finalizeCompleted:
        return:
          thumbnailCode: ${thumbnailResponse.code}
          collageCode: ${collageResponse.code}
    - garbageCollectorCall:
        call: http.post
        args:
          url: ${args.garbageCollectorUri}
          auth:
            type: OIDC
          body:
              gcsImageUri: ${args.gcsImageUri}
        result: garbageCollectorResponse
    - deleteCompleted:
        return:
          garbageCollectorCode: ${garbageCollectorResponse.code}
